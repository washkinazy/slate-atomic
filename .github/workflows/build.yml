name: Build on code changes

on:
  push:
    branches:
      - main
    paths:
      - 'Containerfile'
      - 'build_files/**'
      - 'sys_files/**'
      - 'just/**'
      - '.github/workflows/**'
      - 'Justfile'
  pull_request:
    branches:
      - main
    paths:
      - 'Containerfile'
      - 'build_files/**'
      - 'sys_files/**'
      - 'just/**'
      - '.github/workflows/**'
      - 'Justfile'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref || github.run_id }}
  cancel-in-progress: true

env:
  IMAGE_REGISTRY: ghcr.io
  IMAGE_NAMESPACE: ${{ github.repository_owner }}
  FEDORA_VERSION: 43

jobs:
  # Fast validation checks that run before building
  validate:
    name: Validation checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check for secrets in repo
        run: |
          if git ls-files | grep -E '(cosign\.(key|private)|\.env)$'; then
            echo "::error::Private keys or secrets found in repository!"
            exit 1
          fi
          echo "OK: No secrets found in repository"

      - name: Lint Containerfile with hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: Containerfile
          failure-threshold: warning

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "Linting shell scripts in build_files/"
          find build_files -name "*.sh" -type f -exec shellcheck {} \;
          echo "OK: All shell scripts passed shellcheck"

      - name: Install just
        uses: extractions/setup-just@v2

      - name: Validate Just syntax
        run: |
          echo "Checking Justfile syntax..."
          just --unstable --fmt --check -f Justfile
          echo "Checking just recipes..."
          find . -type f -name "*.just" -exec just --unstable --fmt --check -f {} \;
          echo "OK: Just syntax validation passed"

  # Build and publish images (only pushes on main branch)
  build:
    name: Build ${{ matrix.image }}
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      packages: write
      id-token: write
    strategy:
      fail-fast: false
      matrix:
        image:
          - slate
          - slate-nvidia-open
        include:
          - image: slate
            build_nvidia: "N"
          - image: slate-nvidia-open
            build_nvidia: "Y"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate image metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=pr
            type=ref,event=branch

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        with:
          registry: ${{ env.IMAGE_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Containerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            FEDORA_VERSION=${{ env.FEDORA_VERSION }}
            IMAGE_NAME=${{ matrix.image }}
            IMAGE_VENDOR=${{ env.IMAGE_NAMESPACE }}
            BUILD_NVIDIA=${{ matrix.build_nvidia }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Install cosign
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: sigstore/cosign-installer@v3

      - name: Sign image with cosign
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          COSIGN_EXPERIMENTAL: false
          COSIGN_PRIVATE_KEY: ${{ secrets.SIGNING_SECRET }}
        run: |
          cosign sign --yes --key env://COSIGN_PRIVATE_KEY \
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image }}@${{ steps.build.outputs.digest }}

      - name: Verify signature
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          cosign verify --key cosign.pub \
            ${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image }}@${{ steps.build.outputs.digest }}

      - name: Build summary
        run: |
          echo "### Build Complete: ${{ matrix.image }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${{ matrix.image }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Nvidia**: \`${{ matrix.build_nvidia }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event_name }}" == "push" ] && [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "- **Published**: Yes" >> $GITHUB_STEP_SUMMARY
            echo "- **Registry**: \`${{ env.IMAGE_REGISTRY }}/${{ env.IMAGE_NAMESPACE }}/${{ matrix.image }}:latest\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Signed**: Yes" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Published**: No (not main branch push)" >> $GITHUB_STEP_SUMMARY
            echo "- **Note**: Image built successfully but not pushed to registry" >> $GITHUB_STEP_SUMMARY
          fi

  check:
    name: Check all builds successful
    if: always()
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Check build results
        env:
          JOBS: ${{ toJson(needs) }}
        run: |
          echo "Job status:"
          echo "$JOBS" | jq -r 'to_entries[] | " - \(.key): \(.value.result)"'

          for status in $(echo "$JOBS" | jq -r 'to_entries[] | .value.result'); do
            if [ "$status" != "success" ] && [ "$status" != "skipped" ]; then
              echo ""
              echo "ERROR: Build check failed!"
              exit 1
            fi
          done
          echo ""
          echo "SUCCESS: All builds successful!"
